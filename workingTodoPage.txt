package com.example.plaan;

import java.util.ArrayList;
import java.util.Locale;

import android.app.Activity;
import android.content.Intent;
import android.graphics.Color;
import android.os.Bundle;
import android.view.KeyEvent;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.Window;
import android.view.animation.Animation;
import android.view.animation.AnimationUtils;
import android.view.inputmethod.EditorInfo;
import android.widget.EditText;
import android.widget.ImageButton;
import android.widget.RelativeLayout;
import android.widget.RelativeLayout.LayoutParams;
import android.widget.TextView;
import android.widget.TextView.OnEditorActionListener;

public class TodoPage extends Activity implements OnEditorActionListener,
		OnClickListener {

	ArrayList<ActivitiesPlaan> activitiesList;

	float scale;
	EditText etActivities;
	RelativeLayout todoPageLayout;
	RelativeLayout rlForETActivities;
	TextView tvTodayText;
	TextView tvTodaysDateText;
	TextView tvMinutesLeft;
	TextView tvMin;
	ImageButton bNextButton;
	int uniqueETid;

	int timeRemaining;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		this.requestWindowFeature(Window.FEATURE_NO_TITLE);
		super.onCreate(savedInstanceState);
		setContentView(R.layout.todo_page);
		activitiesList = new ArrayList<ActivitiesPlaan>();
		uniqueETid = 0;

		initializeViews();
		retreiveBundles();
		setTypefaces();
		setDates();

		scale = getApplicationContext().getResources().getDisplayMetrics().density;

		etActivities.setOnEditorActionListener(this);
		bNextButton.setOnClickListener(this);

	}

	private void retreiveBundles() {
		Bundle extras = getIntent().getExtras();
		timeRemaining = extras.getInt("timeRemaining");
		tvMinutesLeft.setText("" + timeRemaining);
	}

	private void setDates() {
		CalendarSetter cs = new CalendarSetter();
		cs.setCalendar(tvTodayText, tvTodaysDateText);
	}

	private void setTypefaces() {
		TypefacePlaan tfp = new TypefacePlaan();
		tfp.setTypeface(etActivities, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvTodaysDateText, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvTodayText, tfp.TITILIUM);
		tfp.setTypeface(tvMinutesLeft, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvMin, tfp.LEAGUE_GOTHIC);
	}

	private void initializeViews() {
		tvMinutesLeft = (TextView) findViewById(R.id.tvMinutesLeft);
		tvMin = (TextView) findViewById(R.id.tvMin);
		etActivities = (EditText) findViewById(R.id.etActivities);
		todoPageLayout = (RelativeLayout) findViewById(R.id.rlTodoPage);
		rlForETActivities = (RelativeLayout) findViewById(R.id.rlForETActivities);
		tvTodayText = (TextView) findViewById(R.id.tvToday);
		tvTodaysDateText = (TextView) findViewById(R.id.tvTodaysDate);
		bNextButton = (ImageButton) findViewById(R.id.bNextButton);
	}

	@Override
	public boolean onEditorAction(TextView view, int actionId, KeyEvent event) {
		if (actionId == EditorInfo.IME_ACTION_NEXT) {
			if (view.getText().toString().length() > 1) {
				String firstLetter = "" + view.getText().toString().charAt(0);
				view.setText(firstLetter.toUpperCase(Locale.ENGLISH)
						+ view.getText().toString().substring(1));
			}
			// create new EditText
			EditText newEditText = new EditText(this);

			int width = (int) (250 * scale + 0.5f);
			int height = (int) (40 * scale + 0.5f);

			newEditText.setWidth(width);
			newEditText.setHeight(height);
			String newEditTextId = "111" + uniqueETid;
			newEditText.setId(Integer.parseInt(newEditTextId));
			LayoutParams paramsForNewEditText = new LayoutParams(width, height);

			if (view.getId() == R.id.etActivities) {
				paramsForNewEditText.addRule(RelativeLayout.BELOW,
						R.id.etActivities);
				paramsForNewEditText.addRule(RelativeLayout.ALIGN_LEFT,
						R.id.etActivities);
				activitiesList.add(new ActivitiesPlaan(etActivities.getText()
						.toString()));

			} else {
				paramsForNewEditText.addRule(RelativeLayout.BELOW,
						newEditText.getId() - 1);
				paramsForNewEditText.addRule(RelativeLayout.ALIGN_LEFT,
						newEditText.getId() - 1);
				EditText prevEtActivities = (EditText) findViewById(newEditText
						.getId() - 1);
				activitiesList.add(new ActivitiesPlaan(prevEtActivities
						.getText().toString()));
			}

			paramsForNewEditText.setMargins(0, (int) (10 * scale + 0.5f), 0, 0);
			newEditText.setImeOptions(EditorInfo.IME_ACTION_NEXT);
			newEditText.setSingleLine();
			newEditText.setBackgroundColor(Color.rgb(82, 148, 165));
			newEditText.setPadding((int) (10 * scale + 0.5f), 0, 0, 0);
			TypefacePlaan tfp = new TypefacePlaan();
			tfp.setTypeface(newEditText, tfp.LEAGUE_GOTHIC);
			newEditText.setTextSize(25);
			newEditText.setTextColor(Color.rgb(242, 242, 242));
			newEditText.setOnEditorActionListener(this);
			Animation comeIn = AnimationUtils.loadAnimation(
					getApplicationContext(), android.R.anim.slide_in_left);
			newEditText.setAnimation(comeIn);
			rlForETActivities.addView(newEditText, paramsForNewEditText);
			uniqueETid++;
		}
		return false;
	}

	@Override
	public void onClick(View v) {
		switch (v.getId()) {
		case R.id.bNextButton:
			Intent i = new Intent("com.example.plaan.SETTIMEPAGE");
			Bundle extras = new Bundle();
			if (uniqueETid == 0) {
				activitiesList.add(new ActivitiesPlaan(etActivities.getText()
						.toString()));
			} else {
				// to get the the bottom et in the to_do_page.xml
				EditText lastET = (EditText) findViewById(Integer
						.parseInt("111" + (uniqueETid - 1)));
				activitiesList.add(new ActivitiesPlaan(lastET.getText()
						.toString()));

			}
			extras.putInt("timeRemaining", timeRemaining);
			extras.putParcelableArrayList("activitiesList", activitiesList);
			i.putExtras(extras);

			startActivity(i);
			break;
		default:
			break;
		}
	}

}
