package com.example.plaan;

import java.util.ArrayList;
import java.util.Locale;

import android.app.Activity;
import android.content.Context;
import android.os.Bundle;
import android.util.Log;
import android.view.KeyEvent;
import android.view.LayoutInflater;
import android.view.View;
import android.view.View.OnClickListener;
import android.view.ViewGroup;
import android.view.Window;
import android.view.animation.Animation;
import android.view.animation.AnimationUtils;
import android.view.inputmethod.EditorInfo;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemSelectedListener;
import android.widget.ArrayAdapter;
import android.widget.EditText;
import android.widget.ImageButton;
import android.widget.ImageView;
import android.widget.LinearLayout;
import android.widget.RelativeLayout;
import android.widget.Spinner;
import android.widget.TextView;
import android.widget.TextView.OnEditorActionListener;

import com.example.plaan.PlaanGeneralClock.GeneralClockListener;

public class SetTimePage extends Activity implements OnClickListener,
		OnEditorActionListener, OnItemSelectedListener {
	TextView tvToday;
	TextView tvTodaysDate;
	TextView tvOneTime;
	TextView tvRepetitive;
	TextView tvActivitiesName;
	ImageView ivSetTimeBox;
	ImageButton ibUncheckedOTBox;
	ImageButton ibUncheckedRBox;
	// ImageButton ibNextButton;
	LinearLayout llOneTime;
	TextView tvHoursStart;
	TextView tvMinutesStart;
	TextView tvHoursEnd;
	TextView tvMinutesEnd;
	TextView tvActivityMinutes;
	TextView tvTimeRemaining;
	TextView tvMin;
	TextView tvHoursR;
	TextView tvMinutesR;
	TextView tvStart;
	TextView tvLoops;
	EditText etLoops;
	TextView tvLoopTime;
	EditText etLoopTime;
	EditText etLoopTimeType;
	TextView tvBreak;
	EditText etBreak;
	EditText etBreakType;
	TextView tvX;
	ImageButton ibNextButtonBreak;
	ImageView ivArrowForward;
	ImageView ivArrowBack;
	RelativeLayout rlMainContent;

	Spinner spinMeridiemStart;
	Spinner spinMeridiemEnd;

	final String[] spinnerMeridiemValues = { "AM", "PM" };

	LinearLayout llRepetitive;

	int activitiesListIndex;
	int timeRemaining;
	int clickedButton;
	boolean itemSelected;

	ArrayList<ActivitiesPlaan> activitiesList;
	ActivitiesPlaan activitiesOnFocus;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		this.requestWindowFeature(Window.FEATURE_NO_TITLE);
		super.onCreate(savedInstanceState);
		setContentView(R.layout.set_time_page);
		activitiesListIndex = 0;
		clickedButton = 0;
		itemSelected = false;

		initializeViews();
		setDates();
		setTypeface();
		retreiveBundles();

		// setting the adapter for the spinner
		// spinMeridiemStart.setAdapter(new MyAdapter(this,
		// R.layout.meridiem_spinner, spinnerMeridiemValues));
		// spinMeridiemEnd.setAdapter(new MyAdapter(this,
		// R.layout.meridiem_spinner, spinnerMeridiemValues));
		//
		// spinMeridiemEnd.setOnItemSelectedListener(this);

		// activate the activities that will be edited
		activitiesOnFocus = activitiesList.get(activitiesListIndex);

		tvActivitiesName.setText(activitiesOnFocus.name);
		tvTimeRemaining.setText("" + timeRemaining);

		// ibNextButton.setOnClickListener(this);
		ibNextButtonBreak.setOnClickListener(this);

		ibUncheckedOTBox.setOnClickListener(this);
		ibUncheckedRBox.setOnClickListener(this);

		tvOneTime.setOnClickListener(this);
		tvRepetitive.setOnClickListener(this);

		tvHoursStart.setOnClickListener(this);
		tvMinutesStart.setOnClickListener(this);
		tvHoursEnd.setOnClickListener(this);
		tvMinutesEnd.setOnClickListener(this);

		tvHoursR.setOnClickListener(this);
		tvMinutesR.setOnClickListener(this);

		ivArrowForward.setOnClickListener(this);
		ivArrowBack.setOnClickListener(this);

		// etLoops.setOnEditorActionListener(this);
		etLoopTime.setOnEditorActionListener(this);
		etLoopTimeType.setOnEditorActionListener(this);

		etBreak.setOnEditorActionListener(this);
		etBreakType.setOnEditorActionListener(this);

	}

	private void retreiveBundles() {
		Bundle extras = getIntent().getExtras();
		timeRemaining = extras.getInt("timeRemaining");
		activitiesList = extras.getParcelableArrayList("activitiesList");
	}

	private void initializeViews() {
		tvToday = (TextView) findViewById(R.id.tvToday);
		tvTodaysDate = (TextView) findViewById(R.id.tvTodaysDate);
		tvOneTime = (TextView) findViewById(R.id.tvOneTime);
		tvRepetitive = (TextView) findViewById(R.id.tvRepetitive);
		tvActivitiesName = (TextView) findViewById(R.id.tvActivitiesName);
		ivSetTimeBox = (ImageView) findViewById(R.id.ivSetTimeBox);
		ibUncheckedOTBox = (ImageButton) findViewById(R.id.ibUncheckedOneTimeBox);
		ibUncheckedRBox = (ImageButton) findViewById(R.id.ibUncheckedRepetitiveBox);
		// ibNextButton = (ImageButton) findViewById(R.id.ibNextButton);
		tvHoursStart = (TextView) findViewById(R.id.tvHoursStart);
		tvMinutesStart = (TextView) findViewById(R.id.tvMinutesStart);
		llOneTime = (LinearLayout) findViewById(R.id.llOneTime);
		tvHoursEnd = (TextView) findViewById(R.id.tvHoursEnd);
		tvMinutesEnd = (TextView) findViewById(R.id.tvMinutesEnd);
		tvActivityMinutes = (TextView) findViewById(R.id.tvActivityMinutes);
		tvTimeRemaining = (TextView) findViewById(R.id.tvTimeRemaining);
		tvMin = (TextView) findViewById(R.id.tvMin);
		tvHoursR = (TextView) findViewById(R.id.tvHoursR);
		tvMinutesR = (TextView) findViewById(R.id.tvMinutesR);
		tvStart = (TextView) findViewById(R.id.tvStart);
		tvLoops = (TextView) findViewById(R.id.tvLoops);
		tvLoopTime = (TextView) findViewById(R.id.tvLoopTime);
		tvBreak = (TextView) findViewById(R.id.tvBreak);
		llRepetitive = (LinearLayout) findViewById(R.id.llRepetitive);
		etLoops = (EditText) findViewById(R.id.etLoops);
		etLoopTime = (EditText) findViewById(R.id.etLoopTime);
		etLoopTimeType = (EditText) findViewById(R.id.etLoopTimeType);
		etBreak = (EditText) findViewById(R.id.etBreak);
		etBreakType = (EditText) findViewById(R.id.etBreakType);
		tvX = (TextView) findViewById(R.id.tvX);
		ibNextButtonBreak = (ImageButton) findViewById(R.id.ibNextButtonBreak);
		ivArrowForward = (ImageView) findViewById(R.id.ivArrowForward);
		ivArrowBack = (ImageView) findViewById(R.id.ivArrowBack);
		rlMainContent = (RelativeLayout) findViewById(R.id.rlMainContent);
		// spinMeridiemStart = (Spinner) findViewById(R.id.spinMeridiemStart);
		// spinMeridiemEnd = (Spinner) findViewById(R.id.spinMeridiemEnd);
	}

	private void setDates() {
		CalendarSetter cs = new CalendarSetter();
		cs.setCalendar(tvToday, tvTodaysDate);
	}

	private void setTypeface() {
		TypefacePlaan tfp = new TypefacePlaan();
		tfp.setTypeface(tvToday, tfp.TITILIUM);
		tfp.setTypeface(tvTodaysDate, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvOneTime, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvRepetitive, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvActivitiesName, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvHoursStart, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvMinutesStart, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvHoursEnd, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvMinutesEnd, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvActivityMinutes, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvTimeRemaining, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvMin, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvHoursR, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvMinutesR, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvStart, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvLoops, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvLoopTime, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvBreak, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(etLoops, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(tvX, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(etLoopTime, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(etLoopTimeType, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(etBreak, tfp.LEAGUE_GOTHIC);
		tfp.setTypeface(etBreakType, tfp.LEAGUE_GOTHIC);
	}

	@Override
	public void onClick(View v) {
		PlaanGeneralClock pgc = new PlaanGeneralClock(this,
				activitiesOnFocus.name);

		switch (v.getId()) {
		case (R.id.tvHoursStart):
		case (R.id.tvMinutesStart):
			pgc.show();
			pgc.setDialogResult(new GeneralClockListener() {
				@Override
				public void finish(String result) {
					SetTimePage.this.tvHoursStart.setText("" + result.charAt(0)
							+ result.charAt(1));
					SetTimePage.this.tvMinutesStart.setText(""
							+ result.charAt(2) + result.charAt(3));
				}
			});
			break;

		case (R.id.tvHoursEnd):
		case (R.id.tvMinutesEnd):
			pgc.show();
			pgc.setDialogResult(new GeneralClockListener() {
				@Override
				public void finish(String result) {
					SetTimePage.this.tvHoursEnd.setText("" + result.charAt(0)
							+ result.charAt(1));
					SetTimePage.this.tvMinutesEnd.setText("" + result.charAt(2)
							+ result.charAt(3));

					setActivitiesPlaanInterval();

					SetTimePage.this.tvActivityMinutes
							.setText(activitiesOnFocus.getInterval() + "Min");
					SetTimePage.this.tvActivityMinutes
							.setVisibility(View.VISIBLE);
					SetTimePage.this.timeRemaining -= SetTimePage.this.activitiesOnFocus
							.getInterval();
					SetTimePage.this.tvTimeRemaining.setText(""
							+ SetTimePage.this.timeRemaining);

					// if (activitiesListIndex != activitiesList.size() - 1)
					// SetTimePage.this.ibNextButton
					// .setVisibility(View.VISIBLE);
					// else
					// SetTimePage.this.ibNextButton
					// .setVisibility(View.INVISIBLE);
				}
			});

			break;
		case (R.id.tvHoursR):
		case (R.id.tvMinutesR):
			pgc.show();
			pgc.setDialogResult(new GeneralClockListener() {
				@Override
				public void finish(String result) {
					SetTimePage.this.tvHoursR.setText("" + result.charAt(0)
							+ result.charAt(1));
					SetTimePage.this.tvMinutesR.setText("" + result.charAt(2)
							+ result.charAt(3));

					setActivitiesPlaanInterval();
					Log.d("pgc repetitive interval",
							"PGCRI -- activitesOnFocus interval = "
									+ activitiesOnFocus.interval);

					SetTimePage.this.timeRemaining -= SetTimePage.this.activitiesOnFocus
							.getInterval();
					SetTimePage.this.tvTimeRemaining.setText(""
							+ SetTimePage.this.timeRemaining);

					if (activitiesListIndex != activitiesList.size() - 1) {
						ibNextButtonBreak.setVisibility(View.VISIBLE);
					} else
						ibNextButtonBreak.setVisibility(View.INVISIBLE);

				}
			});

			break;
		case (R.id.ivArrowForward):
			// go to next activities
			Animation animFadeOut = AnimationUtils.loadAnimation(
					getApplicationContext(), android.R.anim.slide_out_right);
			Animation animFadeIn = AnimationUtils.loadAnimation(
					getApplicationContext(), android.R.anim.slide_in_left);
			rlMainContent.setAnimation(animFadeOut);
			rlMainContent.setVisibility(View.INVISIBLE);
			resetViews();
			activitiesListIndex++;
			activitiesOnFocus = activitiesList.get(activitiesListIndex);
			tvActivitiesName.setText(activitiesOnFocus.name);
			rlMainContent.setAnimation(animFadeIn);
			rlMainContent.setVisibility(View.VISIBLE);
			if (activitiesListIndex == activitiesList.size() - 1)
				ivArrowForward.setVisibility(View.GONE);
			break;
		case (R.id.ibNextButtonBreak):
			// go to the next activities
			activitiesListIndex++;
			activitiesOnFocus = activitiesList.get(activitiesListIndex);
			tvActivitiesName.setText(activitiesOnFocus.name);
			resetViews();
			break;
		case (R.id.tvRepetitive):
			setVisibilityAndType(R.id.ibUncheckedRepetitiveBox,
					ibUncheckedRBox, ibUncheckedOTBox,
					activitiesOnFocus.TYPE_REPETITIVE);
			break;
		case (R.id.ibUncheckedRepetitiveBox):
			setVisibilityAndType(R.id.ibUncheckedRepetitiveBox,
					ibUncheckedRBox, ibUncheckedOTBox,
					activitiesOnFocus.TYPE_REPETITIVE);
			break;
		case (R.id.tvOneTime):
			setVisibilityAndType(R.id.ibUncheckedOneTimeBox, ibUncheckedOTBox,
					ibUncheckedRBox, activitiesOnFocus.TYPE_ONE_TIME);
			break;
		case (R.id.ibUncheckedOneTimeBox):
			setVisibilityAndType(R.id.ibUncheckedOneTimeBox, ibUncheckedOTBox,
					ibUncheckedRBox, activitiesOnFocus.TYPE_ONE_TIME);
			break;
		}
	}

	private void setVisibilityAndType(int clickedButtonComp,
			ImageButton onFocusButton, ImageButton notOnFocusButon, int type) {
		if (clickedButton == clickedButtonComp) {
			onFocusButton
					.setBackgroundResource(R.drawable.light_blue_check_box);
			clickedButton = 0;
			llOneTime.setVisibility(View.INVISIBLE);
			llRepetitive.setVisibility(View.INVISIBLE);
			tvActivityMinutes.setVisibility(View.INVISIBLE);
			activitiesOnFocus.setType(activitiesOnFocus.TYPE_NONE);
		} else if (clickedButton == 0) {
			activitiesOnFocus.setType(type);
			onFocusButton
					.setBackgroundResource(R.drawable.yellow_blue_checked_box);
			clickedButton = onFocusButton.getId();

		} else {
			activitiesOnFocus.setType(type);
			onFocusButton
					.setBackgroundResource(R.drawable.yellow_blue_checked_box);
			notOnFocusButon
					.setBackgroundResource(R.drawable.light_blue_check_box);
			clickedButton = onFocusButton.getId();
		}
		if (clickedButton == R.id.ibUncheckedOneTimeBox) {
			llOneTime.setVisibility(View.VISIBLE);
			llRepetitive.setVisibility(View.INVISIBLE);
		} else if (clickedButton == R.id.ibUncheckedRepetitiveBox) {
			llOneTime.setVisibility(View.INVISIBLE);
			llRepetitive.setVisibility(View.VISIBLE);
		}

	}

	private void resetViews() {
		ibUncheckedOTBox.setBackgroundResource(R.drawable.light_blue_check_box);
		ibUncheckedRBox.setBackgroundResource(R.drawable.light_blue_check_box);
		clickedButton = 0;
		llOneTime.setVisibility(View.INVISIBLE);
		tvHoursStart.setText("");
		tvMinutesStart.setText("");
		tvHoursEnd.setText("");
		tvMinutesEnd.setText("");
		tvActivityMinutes.setVisibility(View.INVISIBLE);
		tvActivityMinutes.setText("");
		// ibNextButton.setVisibility(View.INVISIBLE);
		ibNextButtonBreak.setVisibility(View.INVISIBLE);

	}

	@Override
	public boolean onEditorAction(TextView v, int actionId, KeyEvent arg2) {
		int viewsId = v.getId();
		switch (actionId) {
		case EditorInfo.IME_ACTION_NEXT:
			// Log.d("etMeridiem ERROR", "etMer -- entering IME_NEXT");
			// if (viewsId != R.id.etMeridiemStart && viewsId !=
			// R.id.etMeridiemR) {
			// // viewsId is : etHours / etMinutes
			// Log.d("etMeridiem ERROR", "etMer -- entering adding 0");
			if (v.getText().toString().length() == 1) {
				v.setText("0" + v.getText());
			} else {
				Log.d("etMeridiem ERROR", "etMer -- entering uppercasing");
				v.setText(v.getText().toString().toUpperCase(Locale.ENGLISH));
			}
			break;
		case EditorInfo.IME_ACTION_DONE:
			// // here, v = etMeridiem2
			// if (v.getId() == R.id.etMeridiemEnd
			// || v.getId() == R.id.etMeridiemR) {
			// v.setText(v.getText().toString().toUpperCase(Locale.ENGLISH));
			// if (v.getId() == R.id.etMeridiemEnd) {
			// setActivitiesInterval();
			// tvActivityMinutes.setText(activitiesOnFocus.getInterval()
			// + "Min");
			// tvActivityMinutes.setVisibility(View.VISIBLE);
			// timeRemaining -= activitiesOnFocus.getInterval();
			// tvTimeRemaining.setText("" + timeRemaining);
			//
			// if (activitiesListIndex != activitiesList.size() - 1)
			// ibNextButton.setVisibility(View.VISIBLE);
			// else
			// ibNextButton.setVisibility(View.INVISIBLE);
			// }
			//
			// } else if (v.getId() == R.id.etBreakType) {
			//
			// }

			// here , v = etBreakType
			v.setText(v.getText().toString().toUpperCase(Locale.ENGLISH));
			break;
		}
		return false;
	}

	private void setActivitiesPlaanInterval() {
		if (activitiesOnFocus.type == activitiesOnFocus.TYPE_ONE_TIME) {
			int startHours = Integer
					.parseInt(tvHoursStart.getText().toString());
			int startMinutes = Integer.parseInt(tvMinutesStart.getText()
					.toString());

			int endHours = Integer.parseInt(tvHoursEnd.getText().toString());
			int endMinutes = Integer
					.parseInt(tvMinutesEnd.getText().toString());
			// TODO fix this AM PM THINGY

			activitiesOnFocus.setInterval(startHours, startMinutes, endHours,
					endMinutes, "AM", "AM");
		} else if (activitiesOnFocus.type == activitiesOnFocus.TYPE_REPETITIVE) {
			int startHours = Integer.parseInt(tvHoursR.getText().toString());
			int startMinutes = Integer
					.parseInt(tvMinutesR.getText().toString());
			int loops = Integer.parseInt(etLoops.getText().toString());
			int loopTime = Integer.parseInt(etLoopTime.getText().toString());
			String sLoopType = etLoopTimeType.getText().toString();
			int loopType = 0;
			if (sLoopType.equals("MIN"))
				loopType = activitiesOnFocus.LOOPTYPE_MINUTE;
			else
				loopType = activitiesOnFocus.LOOPTYPE_HOUR;

			int breakTime = Integer.parseInt(etBreak.getText().toString());

			activitiesOnFocus.setInterval(startHours, startMinutes, loops,
					loopTime, loopType, breakTime);

		}

	}

	public class MyAdapter extends ArrayAdapter<String> {
		public MyAdapter(Context ctx, int customSpinnerId, String[] objects) {
			super(ctx, customSpinnerId, objects);
		}

		@Override
		public View getDropDownView(int position, View cnvtView, ViewGroup prnt) {
			return getCustomView(position, cnvtView, prnt);
		}

		@Override
		public View getView(int pos, View cnvtView, ViewGroup prnt) {
			return getCustomView(pos, cnvtView, prnt);
		}

		public View getCustomView(int position, View convertView,
				ViewGroup parent) {
			LayoutInflater inflater = getLayoutInflater();
			View mySpinner = inflater.inflate(R.layout.meridiem_spinner,
					parent, false);
			TextView tvMeridiemSpinner = (TextView) mySpinner
					.findViewById(R.id.tvMeridiemInSpinner);
			TypefacePlaan tfp = new TypefacePlaan();
			tfp.setTypeface(tvMeridiemSpinner, tfp.LEAGUE_GOTHIC);
			tvMeridiemSpinner.setText(spinnerMeridiemValues[position]);
			return mySpinner;
		}
	}

	@Override
	public void onItemSelected(AdapterView<?> parent, View view, int pos,
			long id) {
		if (itemSelected) {
			setActivitiesPlaanInterval();
			tvActivityMinutes.setText(activitiesOnFocus.getInterval() + "Min");
			tvActivityMinutes.setVisibility(View.VISIBLE);

			timeRemaining -= activitiesOnFocus.getInterval();
			tvTimeRemaining.setText("" + timeRemaining);

			// if (activitiesListIndex != activitiesList.size() - 1)
			// ibNextButton.setVisibility(View.VISIBLE);
			// else
			// ibNextButton.setVisibility(View.INVISIBLE);
		}
		itemSelected = true;

	}

	@Override
	public void onNothingSelected(AdapterView<?> arg0) {

	}
}
